+++
title = "rustling in the open source maplibre community"
date = 2023-02-11
description = "notes on contributing to the rust based maplibre project"
draft = false
toc = false
categories = ["technology"]
tags = ["rust", "maplibre", "open source", "maps"]
+++

<!-- 
![caption](../../images/2022-10-01-001-sparql.png "caption")
[text](https://www.url.com) -->

i spent a few months learning rust in the end of 2022 for a few half-formed reasons:

- it was always a desire of mine to learn systems programming. i really want to get into some deeper programming, i do love the creative solutions that web development can provide at the frontend/backend level, but i'm also interested in computer science concepts and at least understanding the ideas of building **for** computer science, not just business. scalability, performance, reliability...
- people talk about it a lot on hacker news and in the blockchain space, but also
- linux is supporting rust cool! so i guess it's it's here to stay

so i learned it https://github.com/kimpham54/rust-book-homework-kim, and was pretty motivated because i was trying to get into the january polkadot blockchain academy in buenos aires. unfotunately i didn't get a chance to take the rust exam...what now? i really enjoyed learning it, so might as well put those amateur skills to use.

to me, contributing to open-source is a beautiful and brutal mechanism for self-reflection and pers/prof growth. the transparency, the feedback, the meritocratic initiative, it's a chance to discover your in/extrinsic motivations and who you are, who you should be, and who you want to be as a worker. i don't know of a better way to know what you truly know/don't know about something since you have to apply your skills in front of an examining audience without any obvious incentive. teaching comes close but even then masks a bit of the truth. it's vulnerable, humbling, empowering. i'm waxing poetic a bit here but it's because in the past my most rewarding and possible idealized professional experiences were when I got to work in open source. I do miss being part of that libraryland world - much love forever goes to Islandora.

truer to my interests and desire to work more with maps, i reached out to max who's heading development on maplibre-rs. i've lurked in the community for a bit, but let him know i was interested in a beginner task. so finally when one came up i volunteered. 

i was working on parsing some style specs over the christmas break. took a break, then came back to it in february, which means i forgot everything. henceforth i shall keep notes, and you're welcome to peruse them too.

## maplibre-rs style parser

here's how the maplibre-rs project is organized. i'm only concerned with the style module.

```

maplibre-rs/maplibre/src/style
├── layer.rs
├── mod.rs
├── original
│   ├── layer.rs
│   ├── source.rs
│   └── style.rs
├── source.rs
├── style.rs
└── tests
    ├── map-styles
    │   ├── test-cl4whef.json
    │   ├── test-cl4whev.json
    │   ├── test-cl4wxue.json
    │   ├── test-dark-v10.json
    │   ├── test-light-v10.json
    │   ├── test-navigation-guidan.json
    │   ├── test-navigation-guidance.json
    │   ├── test-outdoors-v11.json
    │   ├── test-satellite-st.json
    │   ├── test-satellite-v9.json
    │   └── test-streets-v11.json
    ├── test-data
    │   ├── cl4.json
    │   └── sample1.json
    ├── testresult-20220211.json
    └── testresult-20220211b.json

5 directories, 70 files
```

maplibre-rs has the maplibre module which contains styles. here we're trying to parse an input style in json and deserialize it into a rust object.

- source.rs, style.rs, layer.rs - parsers
- original directory: original style files
- tests directory: test data, test results from parser rust tests
- mod.rs - module layout


### serialize
rust object -> json

### deserialize
json -> rust object

i'm using the serde library to do this. we made some rust parsers, right now styles, sources, and layers. style includes the layer and source parsers. in the style parser we have a Style and Metadata rust structs. in the source  we have a VectorSource struct, in layer we have some funky BackgroundPaint, FillPaint, LinePaint structs part of the enum LayerPaint, and a StyleLayer struct. i think the re-organization will grow organically, and eventually should mirror the style spec: https://maplibre.org/maplibre-gl-js-docs/style-spec/. 

wrote some parts of the parser, wrote some tests that input test data max gave me of style exports, good way to flag any attributes/parts of the style spec that weren't accounted for and iterate on writing the parser that way.

to run tests, in style.rs

```
cargo test --package maplibre --lib -- style::style::tests

can also add --nocapture or --show-output for verbose flags

cargo test --package maplibre --lib -- style::style::tests::load_sample_data_two --show-output

cargo test --package maplibre --lib -- style::style::tests::load_sample_data_two --show-output > ./maplibre/src/style/tests/testresult-yyymmdd.json
```

i created a pub extra trait

```
    #[serde(flatten)]
    pub extra: Map<String, Value>
```

which uses serde_json::Value parsing any json data using serde_json::from_str function. you don't have to be explicit, in this case. it grabs everything and dumps it in an object. it'll be good to pick these apart later and properly deserialize them later, if needed or if they are useful or require some additional computation.

serde has a Map struct which I used https://docs.rs/serde_json/latest/serde_json/struct.Map.html, but maybe we can just use HashMap.
